{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Initial Zetta Stack Deployment, init SG, ELB",

  "Parameters": {
    "DiscoveryUrl": {
      "Description": "An unique etcd cluster discovery URL. Grab a new token from https://discovery.etcd.io/new",
      "Type": "String"
    },
    "KeyPair": {
      "Description": "Keypair to use in ASG groups created later.",
      "Type": "String"
    },
    "LogentriesToken": {
      "Description": "LogEntries Token.",
      "Type": "String",
      "Default": ""
    },
    "ZettaStack" : {
      "Description" : "Zetta Stack",
      "Type" : "String"
    },
    "CoreServicesAMI" : {
      "Description" : "CoreOS AMI",
      "Type" : "String"
    },
    "CoreServicesInstanceType" : {
      "Description" : "",
      "Type" : "String"
    },
    "CoreServicesSize" : {
      "Description" : "",
      "Type" : "Number"
    }

  },

  "Resources": {
    "ELBSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Zetta ELB SecurityGroup",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },
    "CoreOsSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Core SecurityGroup, applies to any machine in CoreOS cluster",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },
    "CoreIngress4001": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupName": {"Ref": "CoreOsSecurityGroup"}, "IpProtocol": "tcp", "FromPort": "4001", "ToPort": "4001", "SourceSecurityGroupId": {
          "Fn::GetAtt" : [ "CoreOsSecurityGroup", "GroupId" ]
        }
      }
    },
    "CoreIngress7001": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupName": {"Ref": "CoreOsSecurityGroup"}, "IpProtocol": "tcp", "FromPort": "7001", "ToPort": "7001", "SourceSecurityGroupId": {
          "Fn::GetAtt" : [ "CoreOsSecurityGroup", "GroupId" ]
        }
      }
    },

    "AppSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Core SecurityGroup, applies to any machine in CoreOS cluster",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },
    "AppIngressFromRouter": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupName": {"Ref": "AppSecurityGroup"}, "IpProtocol": "tcp", "FromPort": "3000", "ToPort": "3020", "SourceSecurityGroupId": {
          "Fn::GetAtt" : [ "RouterSecurityGroup", "GroupId" ]
        }
      }
    },

    "RouterSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Core SecurityGroup, applies to any machine in CoreOS cluster",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },
    "RouterIngress80": {
      "Type": "AWS::EC2::SecurityGroupIngress",
      "Properties": {
        "GroupName": {"Ref": "RouterSecurityGroup"}, "IpProtocol": "tcp", "FromPort": "80", "ToPort": "80", "SourceSecurityGroupId": {
          "Fn::GetAtt" : [ "ELBSecurityGroup", "GroupId" ]
        }
      }
    },

    "DataWorkerSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Zetta Sqs data worker",
        "SecurityGroupIngress": [
          {"IpProtocol": "tcp", "FromPort": "22", "ToPort": "22", "CidrIp": "0.0.0.0/0"}
        ]
      }
    },


    "CoreServicesASG": {
      "Type": "AWS::AutoScaling::AutoScalingGroup",
      "Properties": {
        "AvailabilityZones": {"Fn::GetAZs": ""},
        "LaunchConfigurationName": {"Ref": "CoreServicesLaunchConfig"},
        "MinSize": "3",
        "MaxSize": "5",
        "HealthCheckType": "EC2",
        "DesiredCapacity": {"Ref": "CoreServicesSize"},
        "HealthCheckGracePeriod": 60,
        "Tags": [
            {"Key": "zetta:stack", "Value": {"Ref" : "ZettaStack" }, "PropagateAtLaunch": true},
            {"Key": "Name", "Value": { "Fn::Join" : [ "-", [ {"Ref" : "ZettaStack" }, "core-services" ] ] }, "PropagateAtLaunch": true}
        ]
      }
    },
    "CoreServicesLaunchConfig": {
      "Type": "AWS::AutoScaling::LaunchConfiguration",
      "Properties": {
        "ImageId" : {"Ref": "CoreServicesAMI"},
        "InstanceType": {"Ref": "CoreServicesInstanceType"},
        "KeyName": {"Ref": "KeyPair"},
        "SecurityGroups": [{ "Fn::GetAtt" : ["CoreOsSecurityGroup", "GroupId"] }],
        "UserData" : null
      }
    },



    "ZettaELB" : {
      "Type" : "AWS::ElasticLoadBalancing::LoadBalancer",
      "Properties" : {
        "AvailabilityZones" : { "Fn::GetAZs" : "" },
        "CrossZone": true,
        "Listeners" : [
          { "LoadBalancerPort" : "80", "InstancePort" : "80", "Protocol" : "TCP" }
        ],
        "HealthCheck" : {
          "Target": "HTTP:80/",
          "HealthyThreshold": "2",
          "UnhealthyThreshold": "5",
          "Interval": "30",
          "Timeout": "5"
        },
        "ConnectionDrainingPolicy": {
          "Enabled" : "true",
          "Timeout" : "60"
        },
        "SecurityGroups": [ { "Fn::GetAtt" : [ "ELBSecurityGroup", "GroupId" ] } ]
      }
    },

    "DeviceDataQueue": {
       "Type": "AWS::SQS::Queue",
       "Properties": {
          "MessageRetentionPeriod": 1209600,
          "VisibilityTimeout": 1800
       }
    },
    "DeviceDataBucket": {
       "Type" : "AWS::S3::Bucket",
       "Properties" : {}
    },

    "ZettaUsageQueue": {
       "Type": "AWS::SQS::Queue",
       "Properties": {
          "MessageRetentionPeriod": 1209600,
          "VisibilityTimeout": 1800
       }
    },
    "ZettaUsageBucket": {
       "Type" : "AWS::S3::Bucket",
       "Properties" : { }
    },

    "AppRole": {
       "Type": "AWS::IAM::Role",
       "Properties": {
          "AssumeRolePolicyDocument": {
             "Version" : "2012-10-17",
             "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                   "Service": [ "ec2.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
             } ]
          },
          "Path": "/",
          "Policies": [
            {
              "PolicyName": "WriteQueue",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                          {
                            "Effect": "Allow",
                            "Action": ["sqs:SendMessage", "sqs:GetQueueUrl"],
                            "Resource": [ { "Fn::GetAtt" : ["DeviceDataQueue", "Arn"]}, { "Fn::GetAtt" : ["ZettaUsageQueue", "Arn"]} ]
                          }
                      ]
                  }
            }
          ]
        }
    },
    "AppRoleInstanceProfile": {
       "Type": "AWS::IAM::InstanceProfile",
       "Properties": {
          "Path": "/",
          "Roles": [ {
             "Ref": "AppRole"
          } ]
       }
    },
    "DataWorkerRole": {
       "Type": "AWS::IAM::Role",
       "Properties": {
          "AssumeRolePolicyDocument": {
             "Version" : "2012-10-17",
             "Statement": [ {
                "Effect": "Allow",
                "Principal": {
                   "Service": [ "ec2.amazonaws.com" ]
                },
                "Action": [ "sts:AssumeRole" ]
             } ]
          },
          "Path": "/",
          "Policies": [
            {
              "PolicyName": "ReadQueue",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                          {
                            "Effect": "Allow",
                            "Action": [ "sqs:ReceiveMessage", "sqs:DeleteMessage", "sqs:GetQueueUrl", "sqs:GetQueueAttributes" ],
                            "Resource": [ { "Fn::GetAtt" : ["DeviceDataQueue", "Arn"]}, { "Fn::GetAtt" : ["ZettaUsageQueue", "Arn"]} ]
                          }
                      ]
                  }
            },
            {
              "PolicyName": "PutS3",
              "PolicyDocument": {
                "Version": "2012-10-17",
                "Statement": [
                          {
                            "Effect": "Allow",
                            "Action": [
                              "s3:DeleteObject",
                              "s3:DeleteObjectVersion",
                              "s3:GetObject",
                              "s3:GetObjectAcl",
                              "s3:GetObjectTorrent",
                              "s3:GetObjectVersion",
                              "s3:GetObjectVersionAcl",
                              "s3:GetObjectVersionTorrent",
                              "s3:PutObject",
                              "s3:PutObjectAcl",
                              "s3:PutObjectVersionAcl",
                              "s3:RestoreObject"
                            ],
                            "Resource": [ { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "DeviceDataBucket" } , "/*" ]]},
                                          { "Fn::Join" : ["", ["arn:aws:s3:::", { "Ref" : "ZettaUsageBucket" } , "/*" ]]}
                                        ]
                          }
                      ]
                  }
            }
          ]
        }
    },
    "DataWorkerRoleInstanceProfile": {
       "Type": "AWS::IAM::InstanceProfile",
       "Properties": {
          "Path": "/",
          "Roles": [ {
             "Ref": "DataWorkerRole"
          } ]
       }
    }

  }
}
